name: Auto Bash Handler

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write

jobs:
  handle_bash_request:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request == null &&
        github.event.comment.user.login == 'DisabledAbel'

    steps:
      - name: ğŸ§© Check out repository
        uses: actions/checkout@v4

      - name: ğŸ§  Detect emoji reaction
        id: emoji
        run: |
          body="${{ github.event.comment.body }}"
          if echo "$body" | grep -q "ğŸ‘"; then
            echo "reaction=up" >> $GITHUB_OUTPUT
          elif echo "$body" | grep -q "ğŸ‘"; then
            echo "reaction=down" >> $GITHUB_OUTPUT
          else
            echo "reaction=none" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Add Bash script (ğŸ‘)
        if: steps.emoji.outputs.reaction == 'up'
        run: |
          mkdir -p scripts
          safe_title=$(echo "${{ github.event.issue.title }}" | tr ' ' '_' | tr -cd '[:alnum:]_')
          file_name="scripts/${safe_title}.sh"
          echo "${{ github.event.issue.body }}" > "$file_name"
          echo "âœ… Added $file_name"

      - name: ğŸ“– Update README (ğŸ‘)
        if: steps.emoji.outputs.reaction == 'up'
        run: |
          section="## ğŸ“œ Scripts Added Automatically"
          scripts_list=$(find scripts -type f -name "*.sh" -printf "- [%f](scripts/%f)\n" | sort)

          if [ ! -f README.md ]; then
            echo "# Project Scripts" > README.md
          fi

          if ! grep -q "$section" README.md; then
            echo -e "\n$section\n\n$scripts_list" >> README.md
          else
            awk -v s="$section" -v list="$scripts_list" '
              BEGIN {found=0}
              $0 ~ s {print $0; print ""; print list; found=1; next}
              found && /^## / {found=0}
              !found {print $0}
            ' README.md > README.tmp && mv README.tmp README.md
          fi

          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add scripts/ README.md
          git diff --quiet || git commit -m "ğŸª¶ Auto-add bash and update README"
          git push

      - name: âœ… Close issue (ğŸ‘)
        if: steps.emoji.outputs.reaction == 'up'
        id: close
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "âœ… Bash script added, README updated, and issue closed automatically."

      - name: ğŸ§¹ Delete bot comment (ğŸ‘)
        if: steps.emoji.outputs.reaction == 'up'
        uses: peter-evans/delete-comment@v3
        with:
          comment-id: ${{ steps.close.outputs.comment-id }}

      - name: ğŸ”„ Reopen issue (ğŸ‘)
        if: steps.emoji.outputs.reaction == 'down'
        id: reopen
        uses: peter-evans/open-issue@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "ğŸ” Reopened for updates â€” please revise your Bash script."

      - name: ğŸ§¹ Delete bot comment (ğŸ‘)
        if: steps.emoji.outputs.reaction == 'down'
        uses: peter-evans/delete-comment@v3
        with:
          comment-id: ${{ steps.reopen.outputs.comment-id }}
