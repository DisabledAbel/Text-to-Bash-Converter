name: Auto Update README From Issue/Comment

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request == null

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Pull and rebase latest main
        run: |
          git fetch origin main
          git rebase origin/main || true

      - name: Extract formats from issue/comment
        id: formats
        run: |
          # Read from comment if exists, else issue body
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            content="${{ github.event.comment.body }}"
          else
            content="${{ github.event.issue.body }}"
          fi

          # Extract lines starting with "-" or ignore empty lines
          formats=$(echo "$content" | sed '/^\s*$/d' | sed 's/^/- /')
          echo "formats<<EOF" >> $GITHUB_OUTPUT
          echo "$formats" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README section
        run: |
          awk -v list="${{ steps.formats.outputs.formats }}" '
            BEGIN { in_section=0 }
            /^üì¶ Supported Code Block Formats/ {
              print; print ""; 
              print list;
              in_section=1; 
              next
            }
            /^## / && in_section==1 { in_section=0 }
            in_section==0 { print }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit and push safely
        run: |
          git add README.md
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit."
          else
            git commit -m "Auto update Supported Code Block Formats from issue/comment"
            git push --force-with-lease origin HEAD:main
          fi

      - name: Remove previous bot comments
        uses: peter-evans/delete-issue-comments@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          comment-author: 'github-actions[bot]'

      - name: Comment success
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ‚úÖ The **üì¶ Supported Code Block Formats** section in README has been updated dynamically from this issue/comment.
            Previous bot comments have been removed.

      - name: Close issue on üëç reaction
        if: >
          github.event_name == 'issue_comment' &&
          contains(github.event.comment.body, 'üëç')
        uses: peter-evans/close-issue@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
