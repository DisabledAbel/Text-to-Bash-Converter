name: Auto Append Unique README Formats

on:
  workflow_dispatch:
    inputs:
      formats:
        description: 'Optional list of formats (one per line, or Markdown list).'
        required: false
        default: ''
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request == null || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Pull and rebase latest main
        run: |
          git fetch origin main
          git rebase origin/main || true

      - name: Extract formats
        id: formats
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.formats }}" ]; then
            content="${{ github.event.inputs.formats }}"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            content="${{ github.event.comment.body }}"
          else
            content="${{ github.event.issue.body }}"
          fi

          # Normalize lines: remove empty lines, strip leading/trailing spaces, remove leading "-"
          new_formats=$(echo "$content" | sed '/^\s*$/d' | sed 's/^\s*-?\s*//')
          # Convert to markdown list
          new_formats=$(echo "$new_formats" | sed 's/^/- /')
          echo "new_formats<<EOF" >> $GITHUB_OUTPUT
          echo "$new_formats" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Append unique formats to README
        run: |
          # Extract existing formats
          section_start=$(grep -n "^üì¶ Supported Code Block Formats" README.md | cut -d: -f1)
          if [ -z "$section_start" ]; then
            # Section missing: create it at the end
            echo -e "\nüì¶ Supported Code Block Formats\n" >> README.md
            section_start=$(wc -l < README.md)
          fi

          # Find end of section
          section_end=$(tail -n +$section_start README.md | grep -n "^## " | head -n1 | cut -d: -f1)
          if [ -z "$section_end" ]; then
            section_end=$(wc -l < README.md)
          else
            section_end=$((section_start + section_end - 2))
          fi

          # Extract current list
          current_list=$(sed -n "$((section_start+1)),$section_end p" README.md | sed 's/^- //')
          # Extract new formats
          new_list=$(echo "${{ steps.formats.outputs.new_formats }}" | sed 's/^- //')

          # Merge and remove duplicates
          merged=$(echo -e "$current_list\n$new_list" | awk '!seen[$0]++')

          # Build markdown list
          final_list=$(echo "$merged" | sed 's/^/- /')

          # Replace section in README
          head -n $section_start README.md > README.tmp
          echo "" >> README.tmp
          echo "$final_list" >> README.tmp
          tail -n +$((section_end+1)) README.md >> README.tmp
          mv README.tmp README.md

      - name: Commit and push safely
        run: |
          git add README.md
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit."
          else
            git commit -m "Auto append unique Supported Code Block Formats"
            git push --force-with-lease origin HEAD:main
          fi

      - name: Remove previous bot comments (issues only)
        if: github.event_name != 'workflow_dispatch'
        uses: peter-evans/delete-issue-comments@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          comment-author: 'github-actions[bot]'

      - name: Comment success (issues only)
        if: github.event_name != 'workflow_dispatch'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ‚úÖ New unique formats have been appended to the üì¶ Supported Code Block Formats section.
            Previous bot comments have been removed.

      - name: Close issue on üëç reaction
        if: github.event_name == 'issue_comment' && contains(github.event.comment.body, 'üëç')
        uses: peter-evans/close-issue@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
