name: Auto Append Unique README Formats (Idempotent + Manual Approval)

on:
  workflow_dispatch:
    inputs:
      formats:
        description: 'Optional list of formats (one per line, or Markdown list).'
        required: false
        default: ''
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Pull latest main
        run: |
          git fetch origin main
          git rebase origin/main || true

      - name: Extract formats
        id: formats
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.formats }}" ]; then
            content="${{ github.event.inputs.formats }}"
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            content="${{ github.event.comment.body }}"
          else
            content="${{ github.event.issue.body }}"
          fi

          new_formats=$(echo "$content" | sed '/^\s*$/d' | sed 's/^\s*-?\s*//')
          new_formats=$(echo "$new_formats" | sed 's/^/- /')
          echo "new_formats<<EOF" >> $GITHUB_OUTPUT
          echo "$new_formats" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Merge unique formats (idempotent)
        id: merge
        run: |
          section_start=$(grep -n "^üì¶ Supported Code Block Formats" README.md | cut -d: -f1)
          if [ -z "$section_start" ]; then
            echo -e "\nüì¶ Supported Code Block Formats\n" >> README.md
            section_start=$(wc -l < README.md)
          fi

          section_end=$(tail -n +$section_start README.md | grep -n "^## " | head -n1 | cut -d: -f1)
          if [ -z "$section_end" ]; then
            section_end=$(wc -l < README.md)
          else
            section_end=$((section_start + section_end - 2))
          fi

          section_start=${section_start:-0}
          section_end=${section_end:-$(wc -l < README.md)}

          # Extract current list
          current_list=$(sed -n "$((section_start+1)),$section_end p" README.md | sed 's/^- //')

          # Extract new formats
          new_list=$(echo "${{ steps.formats.outputs.new_formats }}" | sed 's/^- //')

          # Merge and remove duplicates (idempotent)
          merged=$(echo -e "$current_list\n$new_list" | awk '!seen[$0]++')
          final_list=$(echo "$merged" | sed 's/^/- /')

          # Save for workflow
          echo "final_list<<EOF" >> $GITHUB_OUTPUT
          echo "$final_list" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Preview merged list (issues only)
        if: github.event_name != 'workflow_dispatch'
        run: |
          PREVIEW_COMMENT_ID=$(gh issue comment ${{ github.event.issue.number }} --body "üìù **Preview of Supported Code Block Formats after append:**\n\n${{ steps.merge.outputs.final_list }}\n\n_Reply with `‚úÖ approve` to commit these changes._" --json id -q ".id")
          echo "preview_comment_id=$PREVIEW_COMMENT_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for approval
        if: github.event_name == 'issue_comment'
        run: |
          if [[ "${{ github.event.comment.body }}" != "‚úÖ approve" ]]; then
            echo "‚ùå Approval not given, skipping commit."
            exit 0
          fi

      - name: Commit and push approved changes (idempotent)
        if: github.event_name == 'issue_comment' && github.event.comment.body == '‚úÖ approve'
        run: |
          section_start=$(grep -n "^üì¶ Supported Code Block Formats" README.md | cut -d: -f1)
          if [ -z "$section_start" ]; then section_start=0; fi
          section_end=$(tail -n +$section_start README.md | grep -n "^## " | head -n1 | cut -d: -f1)
          if [ -z "$section_end" ]; then section_end=$(wc -l < README.md); else section_end=$((section_start + section_end - 2)); fi

          # Safety defaults
          section_start=${section_start:-0}
          section_end=${section_end:-$(wc -l < README.md)}

          # Rebuild README section with idempotent merged list
          head -n $section_start README.md > README.tmp
          echo "" >> README.tmp
          echo "${{ steps.merge.outputs.final_list }}" >> README.tmp
          tail -n +$((section_end+1)) README.md >> README.tmp
          mv README.tmp README.md

          git add README.md
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit."
          else
            git commit -m "Auto append unique Supported Code Block Formats"
            git push --force-with-lease origin HEAD:main
          fi

      - name: Remove previous bot comments
        if: github.event_name != 'workflow_dispatch'
        run: |
          comment_ids=$(gh api \
            -X GET \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            | jq -r '.[] | select(.user.login=="github-actions[bot]") | .id')
          for id in $comment_ids; do
            gh api -X DELETE /repos/${{ github.repository }}/issues/comments/$id
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment success
        if: github.event_name != 'workflow_dispatch'
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "‚úÖ Changes committed after approval. Preview comment removed."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close issue on üëç reaction
        if: github.event_name == 'issue_comment' && contains(github.event.comment.body, 'üëç')
        run: |
          gh issue close ${{ github.event.issue.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
