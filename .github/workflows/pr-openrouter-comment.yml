name: OpenRouter PR Comment Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  comment:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Generate PR comment with OpenRouter
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          PROMPT="You are reviewing a GitHub pull request.

          Title:
          $PR_TITLE

          Description:
          $PR_BODY

          Write a concise PR comment that:
          - Summarizes what the PR does
          - Notes any risks or review concerns
          - Suggests improvements if applicable
          - Keeps it short and professional"

          RESPONSE=$(curl -s https://openrouter.ai/api/v1/chat/completions \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            -H "Content-Type: application/json" \
            -H "HTTP-Referer: https://github.com/$REPO" \
            -H "X-Title: OpenRouter PR Bot" \
            -d "{
              \"model\": \"mistralai/devstral-2512:free\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"You are a helpful GitHub pull request assistant. Be concise and constructive. Do not use markdown headers.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": \"$PROMPT\"
                }
              ]
            }")

          COMMENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

          if [ -z \"$COMMENT\" ] || [ \"$COMMENT\" = \"null\" ]; then
            echo \"No comment generated. Skipping.\"
            exit 0
          fi

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments \
            -d "$(jq -n --arg body \"$COMMENT\" '{body: $body}')"
