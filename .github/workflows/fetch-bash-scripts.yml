name: Fetch Bash Scripts by Repo Topics (PR Approval)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'

jobs:
  fetch-scripts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh git

      - name: Fetch topics and collect Bash scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "Fetching topics for $REPO ..."
          topics_json=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/topics")

          # If there are no topics, exit early
          topics_count=$(echo "$topics_json" | jq -r '.names | length')
          if [ "$topics_count" -eq 0 ]; then
            echo "No topics found for $REPO. Exiting."
            exit 0
          fi

          topics=($(echo "$topics_json" | jq -r '.names[]'))
          echo "Found topics: ${topics[*]}"

          mkdir -p scripts
          any_changes=false

          for topic in "${topics[@]}"; do
            echo "Searching Bash repos with topic: $topic"
            search_url="https://api.github.com/search/repositories?q=topic:${topic}+language:bash&sort=stars&order=desc"
            repos=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$search_url" | jq -r '.items[:5][] | .clone_url')

            for repo in $repos; do
              echo "Cloning $repo"
              git clone --depth 1 "$repo" temp_repo || { echo "clone failed: $repo"; continue; }

              for file in temp_repo/*.sh; do
                [ -f "$file" ] || continue
                dest="scripts/$(basename "$repo")-$(basename "$file")"
                if [ ! -f "$dest" ]; then
                  cp "$file" "$dest"
                  any_changes=true
                fi
              done

              rm -rf temp_repo
            done
          done

          # Export flag for subsequent steps
          echo "ANY_CHANGES=$any_changes" >> $GITHUB_ENV

      - name: Create Pull Request (if changes)
        if: env.ANY_CHANGES == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          branch="auto-bash-update-$(date +%s)"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b "$branch"
          git add scripts/
          git commit -m "Auto fetch new Bash scripts by repo topics" || { echo "Nothing to commit."; exit 0; }
          git push origin "$branch"

          # Check for existing PRs with this head
          existing_pr=$(gh pr list --state open --head "$branch" --json number --jq '.[0].number' || true)

          if [ -z "$existing_pr" ]; then
            pr_body=$(cat <<'EOF'
Hey @DisabledAbel ðŸ‘‹

This PR adds new Bash scripts fetched from repositories that share the same topics as the repository.
Please review and approve before merging.

*(Generated automatically by GitHub Actions)*
EOF
)
            gh pr create --title "Auto fetch new Bash scripts" --body "$pr_body" --base main --head "$branch"
            echo "PR created for branch $branch"
          else
            echo "A PR already exists for branch $branch (PR #$existing_pr). Skipping PR creation."
          fi

      - name: No new scripts
        if: env.ANY_CHANGES != 'true'
        run: echo "No new scripts found. No PR created."
