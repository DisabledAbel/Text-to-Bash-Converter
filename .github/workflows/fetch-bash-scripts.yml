name: Fetch Lightweight Bash Scripts

on:
  schedule:
    - cron: "0 */12 * * *"  # every 12 hours
  workflow_dispatch:

jobs:
  fetch-bash-scripts:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl git

      - name: Fetch lightweight Bash scripts
        id: fetch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p scripts
          NEW_COUNT=0

          echo "üîç Searching for top Bash repositories..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/search/repositories?q=language:bash+stars:>50&sort=updated&order=desc&per_page=5" \
            | jq -r '.items[].full_name' > repos.txt

          echo "üì¶ Found repos:"
          cat repos.txt

          while read repo; do
            echo "‚û°Ô∏è Checking $repo ..."
            git clone --depth 1 "https://github.com/$repo.git" temp-repo || continue

            find temp-repo -type f -name "*.sh" -maxdepth 2 | while read script; do
              size=$(wc -c < "$script")
              name=$(basename "$script")

              # Skip unwanted or generic script names
              if [[ "$name" =~ (install|setup|uninstall|update|deploy)\.sh$ ]]; then
                echo "üö´ Skipping generic script: $name"
                continue
              fi

              # Skip large files
              if [ "$size" -ge 10240 ]; then
                echo "üö´ Skipping $name (too large: ${size} bytes)"
                continue
              fi

              # Skip if already exists in scripts/ or app/
              if grep -qr "$name" scripts/ app/ 2>/dev/null; then
                echo "‚öôÔ∏è Script $name already exists in project, skipping."
                continue
              fi

              # Save new script with attribution
              newname="scripts/${repo//\//_}-${name}"
              echo "# Source: https://github.com/$repo" > "$newname"
              echo "# Added: $(date -u)" >> "$newname"
              echo "" >> "$newname"
              cat "$script" >> "$newname"
              echo "‚úÖ Added $newname ($size bytes)"
              ((NEW_COUNT++))
            done

            rm -rf temp-repo
          done < repos.txt

          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT

      - name: Commit and push new scripts
        if: steps.fetch.outputs.new_count != '0'
        run: |
          COUNT=${{ steps.fetch.outputs.new_count }}
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add scripts/
          git commit -m "üîÅ Added ${COUNT} new Bash script(s)"
          git push

      - name: No new scripts found
        if: steps.fetch.outputs.new_count == '0'
        run: echo "üü¢ No new scripts found."
