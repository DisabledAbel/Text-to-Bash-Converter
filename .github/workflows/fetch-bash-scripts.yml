name: Fetch Bash Scripts by Repo Topics (PR Approval)

on:
  workflow_dispatch:
  schedule:
    # Runs every 10 minutes
    - cron: '*/10 * * * *'

jobs:
  fetch-scripts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Install required tools
      - name: Install jq and GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      # 3Ô∏è‚É£ Fetch topics and collect Bash scripts
      - name: Fetch Bash scripts by repo topics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching topics for $REPO ..."
          topics_json=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/topics")

          topics=($(echo "$topics_json" | jq -r '.names[]'))
          echo "Found topics: ${topics[*]}"

          mkdir -p scripts
          any_changes=false

          for topic in "${topics[@]}"; do
            echo "üîç Searching Bash repos with topic: $topic"
            search_url="https://api.github.com/search/repositories?q=topic:$topic+language:bash&sort=stars&order=desc"
            repos=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$search_url" | jq -r '.items[:5][] | .clone_url')

            for repo in $repos; do
              echo "‚§µÔ∏è Cloning $repo"
              git clone --depth 1 "$repo" temp_repo

              for file in temp_repo/*.sh; do
                [ -f "$file" ] || continue
                dest="scripts/$(basename "$repo")-$(basename "$file")"
                if [ ! -f "$dest" ]; then
                  cp "$file" "$dest"
                  any_changes=true
                fi
              done

              rm -rf temp_repo
            done
          done

          if [ "$any_changes" = true ]; then
            echo "‚úÖ New scripts found, preparing pull request..."
            branch="auto-bash-update-$(date +%s)"
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git checkout -b "$branch"
            git add scripts/
            git commit -m "Auto fetch new Bash scripts by repo topics"
            git push origin "$branch"

            # Check if a similar PR already exists
            existing_pr=$(gh pr list --state open --json headRefName -q '.[] | select(.headRefName=="'$branch'") | .headRefName')
            if [ -z "$existing_pr" ]; then
              gh pr create \
                --title "Auto fetch new Bash scripts" \
                --body "$(cat <<EOF
Hey @DisabledAbel üëã  

This PR adds new Bash scripts fetched from repositories that share the same topics as **${REPO}**.  
Please review and approve before merging.  

*(Generated automatically by GitHub Actions)*
EOF
)"
                --base main \
                --head "$branch"
            else
              echo "‚ö™ Skipping PR creation ‚Äî one already exists for branch $branch."
            fi
          else
            echo "‚ö™ No new scripts found. No pull request created."
          fi
