name: Fetch Bash Scripts by Repo Topics (PR Approval)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  fetch-scripts:
    runs-on: ubuntu-latest
    outputs:
      pr_opened: ${{ steps.create_pr.outputs.pr_opened }}
      pr_number: ${{ steps.create_pr.outputs.pr_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh git

      - name: Fetch topics and collect Bash scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          echo "Fetching topics for $REPO ..."
          topics_json=$(curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/topics")

          topics_count=$(echo "$topics_json" | jq -r '.names | length')
          if [ "$topics_count" -eq 0 ]; then
            echo "ANY_CHANGES=false" >> $GITHUB_ENV
            exit 0
          fi

          topics=($(echo "$topics_json" | jq -r '.names[]'))
          mkdir -p scripts
          any_changes=false

          for topic in "${topics[@]}"; do
            echo "Searching Bash repos with topic: $topic"
            search_url="https://api.github.com/search/repositories?q=topic:${topic}+language:bash&sort=stars&order=desc"
            repos=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$search_url" | jq -r '.items[:5][] | .clone_url')

            for repo in $repos; do
              echo "Cloning $repo"
              git clone --depth 1 "$repo" temp_repo || continue

              for file in temp_repo/*.sh; do
                [ -f "$file" ] || continue
                dest="scripts/$(basename "$repo")-$(basename "$file")"
                if [ ! -f "$dest" ]; then
                  cp "$file" "$dest"
                  any_changes=true
                fi
              done
              rm -rf temp_repo
            done
          done

          if [ "$any_changes" = true ]; then
            echo "ANY_CHANGES=true" >> $GITHUB_ENV
          else
            echo "ANY_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request (if changes)
        id: create_pr
        if: env.ANY_CHANGES == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          existing_heads=$(gh pr list --state open --json headRefName --jq '.[].headRefName' || true)
          if echo "$existing_heads" | grep -E '^auto-bash-update' >/dev/null 2>&1; then
            echo "pr_opened=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          branch="auto-bash-update-$(date +%s)"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b "$branch"
          git add scripts/
          git commit -m "Auto fetch new Bash scripts by repo topics" || { echo "pr_opened=false" >> $GITHUB_OUTPUT; exit 0; }
          git push origin "$branch"

          pr_url=$(gh pr create \
            --title "Auto fetch new Bash scripts" \
            --body "Automated PR adding new scripts." \
            --base main \
            --head "$branch")

          pr_number=$(echo "$pr_url" | sed 's/.*pull\/\([0-9]*\).*/\1/')

          echo "pr_opened=true" >> $GITHUB_OUTPUT
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

      - name: No new scripts
        if: env.ANY_CHANGES != 'true'
        run: echo "No new scripts found. No PR created."


  send-email:
    runs-on: ubuntu-latest
    needs: fetch-scripts
    if: needs.fetch-scripts.outputs.pr_opened == 'true'

    steps:
      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "New Auto PR Created in Text-to-Bash-Converter"
          to: "YOUR_EMAIL_HERE"
          from: "GitHub Actions <${{ secrets.MAIL_USERNAME }}>"
          body: |
            A new automated Pull Request has been created.

            Repo: ${{ github.repository }}
            PR Number: ${{ needs.fetch-scripts.outputs.pr_number }}
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            This was triggered by new Bash scripts being detected.
